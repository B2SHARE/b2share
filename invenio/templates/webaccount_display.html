{#
## This file is part of Invenio.
## Copyright (C) 2012 CERN.
##
## Invenio is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
##
## Invenio is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Invenio; if not, write to the Free Software Foundation, Inc.,
## 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#}
{% from "_formhelpers.html" import render_field with context %}
{% from "websearch_helpers.html" import record_brief_links with context %}
{% extends "page.html" %}
{% set title = _('Your Account') %}

{% block title %}
<div class="page-header">
  <h1>{{ title }}</h1>
</div>
{% endblock %}

{% block body %}

{% macro render_search_pagination(pagination) %}
  {%- set args = request.args.copy().to_dict() -%}
  {%- set form_args = request.form.copy().to_dict() -%}
  {%- if form_args|length() and 'filter' in form_args -%}
    {%- do form_args.pop('filter') -%}
    {%- do args.update(form_args) -%}
    {%- set hash_tag = '#'+request.form.get('filter','') -%}
  {%- else -%}
    {%- set hash_tag = '' -%}
  {%- endif -%}
  <div style="margin:0px;" class="pagination pull-right">
    <ul>
      <li{{ ' class="disabled"'|safe if not pagination.has_prev }}>
        {%- do args.update({'jrec': 1}) -%}
        <a title="first" href="{{ url_for('search.search', **args)+hash_tag }}">«</a></li>
      <li{{ ' class="disabled"'|safe if not pagination.has_prev }}>
        {%- set jrec = (pagination.page-1)*pagination.per_page if pagination.has_prev else 1 -%}
        {%- do args.update({'jrec': jrec}) -%}
        <a title="prev" href="{{ url_for('search.search', **args)+hash_tag }}">&lsaquo;</a></li>
      {%- for page in pagination.iter_pages() %}
        {%- if page -%}
      <li{{ ' class="active"'|safe if page == pagination.page }}>
        {%- do args.update({'jrec': (page-1)*pagination.per_page+1}) -%}
        <a href="{{ url_for('search.search', **args)+hash_tag }}">{{ page }}</a>
      </li>
        {%- else -%}
          <li class="disabled"><a href="{{ hash_tag|default('#', true) }}">...</a></li>
        {%- endif -%}
      {%- endfor -%}
      <li{{ ' class="disabled"'|safe if not pagination.has_next }}>
        {%- set jrec = (pagination.page+1)*pagination.per_page if pagination.has_next else (pagination.pages-1)*pagination.per_page+1 -%}
        {%- do args.update({'jrec': jrec}) -%}

        <a href="{{ url_for('search.search', **args)+hash_tag }}">&rsaquo;</a></li>
      <li{{ ' class="disabled"'|safe if not pagination.has_next }}>
        {%- do args.update({'jrec': (pagination.pages-1)*pagination.per_page+1}) -%}
        <a title="last" href="{{ url_for('search.search', **args)+hash_tag }}">»</a>
      </li>
    </ul>
  </div>
{% endmacro %}

{% macro render_search_results(recids, collection, pagination, format_record) %}
      <form class="clearfix form-horizontal" name="" action="{{ url_for('search.dispatch') }}" method="post">
        <span class="btn-group">
        </span>
        <p class="help-inline hidden-phone">
          {%- set r_from = (pagination.page-1)*pagination.per_page+1 -%}
          {%- set r_to = pagination.page*pagination.per_page -%}
          {%- set r_of = recids|length -%}
          {%- set r_to = r_to if r_to < r_of else r_of -%}
          {{ _('Showing records %d to %d out of %d results.') % (r_from, r_to, r_of) }}
        </p>
        <div class="btn-group pull-right">

          <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
            <i class="icon-random"></i> {{ _('Sort by') }}
            <span class="caret"></span>
          </a>

          {%- set args = request.values.copy().to_dict() -%}
          {%- set form_args = request.form.copy().to_dict() -%}
          {%- if form_args|length() and 'filter' in form_args -%}
            {%- do form_args.pop('filter') -%}
            {%- do args.update(form_args) -%}
          {%- endif -%}
          {%- set new_args = args.copy() -%}
          {%- if 'so' in new_args -%}
            {%- do new_args.pop('so') -%}
          {%- endif -%}
          {%- if 'rm' in new_args -%}
            {%- do new_args.pop('rm') -%}
          {%- endif -%}

          <ul class="dropdown-menu">
          {%- for (k,v,vv) in [('Most recent', 'rm', ''), ('Most cited', 'rm', 'citation'), ('Most relevant', 'rm', 'wrd')] -%}
            {%- set active = request.values.get(v,'') == vv -%}
            {%- set used_args = new_args.copy() -%}
            {%- do used_args.update({v:vv}) -%}
            <li>
            <a href="{{ url_for('search.search', **used_args) }}{{ '#'+request.form.get('filter','')|default('', true) }}"
               class="{{ 'active' if active }}">
              <i class="pull-right icon {{ ' icon-ok' if active }}"></i>
                {{ _(k) }}
            </a>
            </li>
          {%- endfor -%}
            </li>
          </ul>
        </div>

        <hr/>

        {%- set of = request.values.get('of', 'hb') -%}
        {%- for recid in recids[(pagination.page-1)*rg:pagination.page*rg] -%}
          {%- if of[0] == 'h' -%}
            <div class="row-fluid">
              <div class="span1">
                  {{ loop.index+(pagination.page-1)*rg }}
              </div>
              <div class="span11">
                {{ format_record(recid, of, ln=g.ln)|safe }}
                {{ record_brief_links(recid, loop.index+(pagination.page-1)*rg) }}
              </div>
            </div>
          {%- else -%}
          {{ format_record(recid, of, ln=g.ln) }}
          {%- endif -%}
        {%- endfor -%}
        <hr/>
        <div class="row clearfix">
          <div class="span12">

            {{ render_search_pagination(pagination) }}
          </div>
        </div>
      </form>
{% endmacro %}

<div class="container">
  <div class="row">

    <div class="span12 acctext">
      <dl class="dl-horizontal">
        <dt>User Name:</dt><dd>{{nick}}</dd>
        <dt>e-mail:</dt><dd>{{email}}</dd>
      </dl>

      <a href="{{url_for('youraccount.edit')}}">Edit Settings</a>
      <p/>
    </div>

    <div class="span12">
      <h2>Your Submissions</h2>
      <hr/>
      {{ render_search_results(recids, collection, pagination, format_record) }}
    </div>
  </div>
</div>

<style>
.acctext {
  font-size: 16px;
  line-height: 25px;
}
</style>
{% endblock %}
